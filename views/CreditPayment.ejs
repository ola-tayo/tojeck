
<!doctype html>
<html lang="en">
    <head>
        <title>BADE||PAYMENTS REGISTER</title>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <link rel="icon" type="image/x-icon" href="https://allchannels.com.ng/BADES.jpg">
        <link rel="stylesheet" href="/sale.css" />
        <!-- Bootstrap CSS v5.2.1 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
    </head>
  
    <body>
        <header>
            <%-include('./partials/Notification.ejs')%> 
            <%-include('./partials/inactive.ejs')%>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
            <!-- place navbar here -->
            <nav class="dash navbar navbar-light bg-light fixed-top" 
            style="background-color: rgb(173, 168, 105) !important">
                <div class="container-fluid">
                    <span  class="navbar-brand" >
                        <img 
                        onclick="history.back()"
                        width="30"
                        hegith="30"
                        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAA
                        ACXBIWXMAAAsTAAALEwEAmpwYAAAEgklEQVR4nO2a/U/VVRzH31xEbjxEQmjYAobWUkdYIiYxYYg8c+/9HrqUhAaFbvaE60lnOVzTrRbFMCZjNkmvGV6433NjjY2W1WzrgVHNkq0VtkxXZmqaUwyBTzv0Zd01TO4ZP3zP5b628we8vp/z9P5+DhAkSJAgUw1RyPpWCsN0wOmmUI1TK+Pkzf6IZiCQcbpppqZTO+NEYmicXPX1ZEEgUtpFEYxT97isz2hGoOF0UxTjdGgC2fFKb0Og4HRTLOP0xbVkfcYzUB3NQwmM07eTkCWm0yjj9ChUhXVSisbp2KRk/53aw5pOTqiGndNiptMpf2R9pLdDJRw6ZTBOZ2Rkcxu+PAhAnQuJ5qFcjdNFv2V1Gl2+me8FsBpAJlTAoZNd4zTo9xTWR0bS6/a1GLI2ANEwO4zTGqbTVb9lPcNDd9U2vW7IlgCIgNnROD1pHCl+yTo6hwYXVr60w5AtABAOs6Nx2iSzOdk7rlycX/b0VkN2pfk3KqIQplOjjKyt/dIfibk1zxuyKwCEwuzxjum0R0a27O0LpxMy7Bt9dmNzJ6XCbgpnnDwysqWucyfjFq14zJBNBxACM1PVQ5GM0/sysiV7Tw/EJKetM2TTYHZK3qNZjNNnMrJFu0/0R8xJqTFkF8DsON10i6bTERnZgpZjfdbo+LUAHgQwD2bHzilZ0+kHGdm8nf2fWKyRVQAeAJAIs+P00kJNp5MysrkNfT0WS1glgAoACTA75V5KZzr9LiObveNwl7FeywHEw+yUc8phOv0plXi2dLkMWQ3ALJgdxqlMNvEsrXO1GrJ2JRLPFAmrkXh8CE2rbdro6PhrUGZK29svizuyUtwtpuW84sdfcBwc9H8d/yP+MhQiFECOkE7MrnrW9s6ls1LSnJpVaqFYANwnpOcsKX6qdP952b+PLpWaZSEAlgrpuDsyN5TsO3Nccnq/+3AbWaEQi4V0VOKi2uK2X6WumJpOH9q8pMYxZbBQSEfE31ZduPv4N5JrutehUxwUYr5IPGHRsWvzd33fK1npfpuX5kIhkkTysYRZH1rZeORjSekfHTqZPyb6ICpUAYulMueVzydqbk9m/GLnlAqFmA3gfrGuM7d2H5A8ss5qHroXChErrt5Cetkmz1syP+LHelBeyoNC3Ggko9VLntizS9NHhiXO6Sual0SUVIZI8V5FSKc+0tjg8Fwdkqi0+FDVUAgrgCIhfWdF/XbRM5Ko9CjTqQ4KMRPAKiGdUlr3ot096H+PWMGkNWM8aSXlr99sb798fjo8ebAAyBLSCem2urIDF36bDo9aQgBkjCWtBVkbSl3nfp7sOl72XMcbyvwPm4B7hHRMYuq6krZTA9cTXr6la79Sbzz+P2kl1RS9eeLotWSztn3Qacjmm785fn1uF0krPHZudWHrT1//Vzbn1d4eQ7ZYiWcPkyR5LF5G3LRmVfN3n47L5jUdPWy0ZMoA3IAA41aRtES8zH3tq0MFLQN9RrPNASAKAcrssaRlsVSGWaOrjP6T+VsyU5S0RGfxZkwTYoxqBwkC//gbNIgEXXRi6msAAAAASUVORK5CYII=">
                       <b> Payments</b>
                    </span>
                    <button
                        class="navbar-toggler"
                        type="button"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasNavbar"
                        aria-controls="offcanvasNavbar"
                    >
                    <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div
                        class="offcanvas offcanvas-end"
                        tabindex="-1"
                        id="offcanvasNavbar"
                        aria-labelledby="offcanvasNavbarLabel"
                    >
                        <div class="dash offcanvas-header bg-dark-subtle ">
                            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">
                                Menu
                            </h5>
                            <button
                                type="button"
                                class="btn-close text-reset"
                                data-bs-dismiss="offcanvas"
                                aria-label="Close"
                            ></button>
                        </div>
                        <div class="offcanvas-body ">
                            <!-- uls -->
                            <ul class="nav nav-tabs d-flex  align-content-center  " id="myTab" role="tablist" >
                              <%-include('./partials/USER.ejs')%>
                            <%if(user.postPayment || user.isAdmin || user.isCFO){%>
                                <li class="nav-item " role="presentation">
                                    <button
                                        class="nav-link "
                                        id="profile-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#profile"
                                        type="button"
                                        role="tab"
                                        aria-controls="profile"
                                        aria-selected="false"
                                        title=""
                                    >
                                    Register New Payment
                                    </button>
                                </li>
                                <%}%>
                                <li class="nav-item active" role="presentation">
                                    <button
                                        class="nav-link active"
                                        id="messages-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#messages"
                                        type="button"
                                        role="tab"
                                        aria-controls="messages"
                                        aria-selected="false"
                                        title="Expense List"
                                    >
                                    Payment Log
                                    </button>
                                </li>
                               </ul> 
                               <div class="d-flex border">
                                <input  type="text" id="search" class="form-control " placeholder="Search payment refrence or Amount" />
                                <button disabled class="btn btn-success" type="submit">
                                    Search
                                </button>
                              </div>
                            <hr>
                            
                             <!-- ends here -->
                        <!-- expense category -->
                        <div class="list-group mb-5" >
                          <!-- display anything you like here -->
                        
                        </div>
                       <!-- endes here -->
                        </div>
                         
                    </div>
                </div>
            </nav>
            
           <!-- Nav tabs -->
          
        </header>

        <main class="pt-4 ">
            <!-- Tab panes -->
            <div class="tab-content mt-5 ">
           
                <div
                    class="tab-pane "
                    id="profile"
                    role="tabpanel"
                    aria-labelledby="profile-tab"
                >
                   <div class="container ">
                    <%if(user.postPayment || user.isAdmin || user.isCFO){%>
                   <!-- display payment form -->

                   <form  class="row g-3 needs-validation container border shadow rounded p-5 mt-5 mb-5 bg-light" id="paymentForm">
                   
                          <!-- <h5>Register Payment</h5> -->
                          <h6>REGISTER NEW PAYMENT</h6>
                     
                      <p id="words" style="color:#ecb265" ></p>
                      <div class="col-md-4">
                          <label for="customer" class="form-label">CUSTOMER CODE</label>
                          
                          <select required id="customer" class="form-select">
                            <option  value="">Choose...</option>
                            <%if(creditCustomes.length > 0){%>
                                <%creditCustomes.forEach((customer)=>{%>
                                    <option value="<%=customer._id%>"><%=customer.Username%> [<%=customer.category%>]</option>
                                <%})%>
                            <%}%>   
                          </select>
                      </div>
        
                      <div class="col-md-4">
                        <label for="validationCustom01" class="form-label">CREDITED ACCOUNT </label>
                        <h5 id="PaymentAccount"></h5>
                        <!-- <select id="pickManager" name="BankJornal" required class="form-select border" required>
                          <option value="">Choose...</option>
                          <%if(Acconuts.length > 0){%>
                            <%Acconuts.forEach((account)=>{%>
                              <option value="<%=account.AccountNum%>"><%=account.bankName%></option>
                            <%})%>
                            <%}%>
                        </select> -->
                    </div>
        
                    <div class="col-md-4">
                        <label for="validationCustom01" class="form-label">DATE</label>
                        <input type="date" required  class="form-control" name="PaymentDate"/>
                       
                    </div>
        
                    <div class="col-md-4">
                        <label for="validationCustom01" class="form-label">ACCOUNTANT</label>
                        <h5><%=user.firstName.toUpperCase()%> <%=user.lastName.toUpperCase()%></h5>
                        <input type="text"  value="<%=user.firstName%> <%=user.lastName%>" Name="Accountant" hidden  disabled>
                    </div>
        
                    <div class="col-md-4">
                      <label for="validationCustom01" class="form-label">Payment RefNo</label>
                      <input type="text"  Name="PaymentRef" class="form-control" placeholder="Enter Payment Refrence" required>
                  </div>
        
                    <div class="col-md-4">
                      <label for="validationCustom01" class="form-label">Customer Name</label>
                      <h5 id="customerName"></h5>
                  </div>
        
                    <div class="col-md-4">
                      <label for="validationCustom01" class="form-label">TRANSACTION TYPE</label>
                      <select class="form-select" name="TRANSACTION" required>
                        <option disabled value="">Choose...</option>
                        <!-- <option value="DR">DEBIT PAYMENT</option> -->
                        <option selected value="CR">PAYMENT</option>
                      </select>
                  </div>
        
                    <div class="col-md-4">
                        <label for="validationCustom01" class="form-label">AMOUNT RECEIVED </label>
                        ₦<input type="number" placeholder="Amount collected " required class="form-control border" id="Amount" name="Amount"/>
                    </div>
        
                    <!-- <div class="col-md-4">
                        <label for="supportDoc" class="form-label">UPLOAD ATTACHMENT </label>
                        <input type="file"  class="form-control"  id="supportDoc" name="Attachment"/>
                    </div> -->
        
                    <div class="col-md-4">
                        <label for="InvoiceNo" class="form-label">CUSTOMER WALLET</label>
                       <h5 id="debt" style="color: red;"></h5>
                    </div>
        
                    <div class="col-md-4">
                      <label for="InvoiceNo" class="form-label">CREDIT LIMIT</label>
                     <h5 id="dwp" style="color: yellowgreen;"></h5>
                  </div>
        
                    <!-- <div class="progress">
                      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100" style="width: "></div>
                    </div> -->
                    <!-- <div class="progress col-md-4" style="height: 3px;" title="Attachement upload progress"> 
                      <div class="progress-bar progress-bar-striped progress-bar-animated " role="progressbar" id="progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div> -->
        
                    <!-- <div class="col-md-4">
                      <label for="validationCustom01" class="form-label">REMARKS</label>
                      <textarea type="text"  name="remarks" required class="form-control" autocomplete="off" autocapitalize="on"></textarea>
                  </div> -->
        
                    <div class="col-md-4  ">
                      <label for="InvoiceNo" class="form-label"> ALL DONE!</label>
                        <button class="btn btn-success form-control" id="submit" >Confirm Payment</button>
                    </div>
                    
                  </form>

                   <!--  -->
                    <% } %>
                   </div>
                </div>
                <div
                    class="tab-pane active"
                    id="messages"
                    role="tabpanel"
                    aria-labelledby="messages-tab"
                >
                   <div class="container-fluid mt-5 mb-5 " id="tbody">
                       <!-- display payment -->
                       <%if(result.creditPayment.length > 0){%>
                        <%result.creditPayment.sort((a,b)=>{return b.createdAt - a.createdAt}).forEach(Payment=>{%>
                          <span  class="list-group position-relative mb-2" title=" <%=Payment.PaymentDate%>"  id="reverseID"  data-reverse="<%=Payment._id%>">
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="rev" >
                                <small class="position-absolute top-0  start-50 translate-middle badge rounded-pill bg-warning"title=''>
                                  <span class="badge bg-secondary">
                                    <%if(Payment.cr){%>
                                      ₦<%=Payment.crAmount%>
                                    <%}else{%>
                                      ₦<%=Payment.drAmount%>
                                    <%}%>  
                                    </span>
                                </small>
                                   
                                  <div>
                                       
                                        <a class="link-offset-2 link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover" href="/api/v1/payments/<%= Payment._id %>"><%if(Payment.cr){%>
                                          CR
                                          <%}else{%>
                                          DR
                                          <%}%>  
                                          /<%=Payment.collectionRef%>/<%=Payment.paymentReferenceNo%>/<%=Payment.PaymentDate%>
                                        </a>
                                       
                                  </div>
                                  <div>
                                  </div>
                                 <small class="<%if(Payment.status === 'pending'){%>
                                  bg-secondary
                                  <%}else if(Payment.status === 'posted'){%>
                                    bg-success
                                 <%}else{%>
                                  bg-danger
                                 <%}%> text-light p-1 rounded shadow"> <%=Payment.status%></small>
                                </div> 
                            </span>
                        <%})%>
                    <%}else{%>
                    <div class="container">
                        <p>No Payment Registered yet..!!</p>
                    </div>
                    <%}%>
                   
                   </div>
                    
                </div>
               </div>
        </main>
        <footer style="z-index: 3 !important;">
          <!-- place footer here -->
          <div class="container-fluid fixed-bottom bg-dark-subtle ">
              <div class="row p-2">
                  <!-- for next and filter -->
                  <div class="contaner d-flex justify-content-between">
                    <div>
                             <!-- next and prev btn -->
                             <button type="button" class="btn btn-dark shadow-sm me-2"
                             <%if(!result.Previous){%>
                               disabled
                               <%}%>
                               <%if(result.Previous){%>
                                 onclick="location.assign('/api/v1/Credit/customers/<%=user._id%>/payment?page=<%=result.Previous.page%>&limit=9')"
                                 <%}%>
                             >
                             Prev
                           </button>
                             
                             <button type="button" class="btn btn-dark shadow-sm me-2" <%if(!result.next){%>
                               disabled =true
                               <%}%>
                               <%if(result.next){%>
                                 onclick="location.assign('/api/v1/Credit/customers/<%=user._id%>/payment?page=<%=result.next.page%>&limit=9')"
                                 <%}%>
                               >
                               Next
                              </button>
                     <!--  -->
                    </div>
 
                    <div>
                     
                    </div>
                          <div class="row">
                            <div class="col-12">
                                <p class="text-center">
                                    BADE &copy; <script>
                                        document.write(new Date().getFullYear());
                                    </script>. All rights reserved.
                                </p>
                            </div>
                        </div>
                     </div>
              </div>
          </div>
          <!-- end of footer -->
          <input type="hidden" id="Signature" value="<%=user.Signature%>">
      </footer>
        <!-- Bootstrap JavaScript Libraries -->
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"
        ></script>

    <script>
     
   

   //get search element from DOM 
   const searchInput = document.getElementById('search')
    searchInput.addEventListener("change", async (e)=>{
    plsWait(true)
    const endPoint = `/api/v1/GetAllpayments`
          const res =await fetch(endPoint,{
            method:'GET',
            headers:{'Content-Type': 'application/json'}
          })
          const payment = await res.json()
          plsWait(false)

      const FilteredProduct = payment.sort((a,b)=>{return b.createdAt - a.createdAt}).filter(Payment=>{
        const display = document.getElementById('tbody').innerHTML = '';
        return Payment.paymentReferenceNo.toLowerCase().includes(e.target.value.toLowerCase().trim()) || Payment.crAmount === parseInt(e.target.value.trim())  && Payment.collectionRef === 'PMNT';
      })
  
      const product = await FilteredProduct.map(Payment => {
        return`
        <span  class="list-group position-relative mb-2" title=" ${Payment.PaymentDate}"  id="reverseID"  data-reverse="${Payment._id}">
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="rev" >
                                <small class="position-absolute top-0  start-50 translate-middle badge rounded-pill bg-warning"title='grand total of this bill'>
                                  <span class="badge bg-secondary">
                                    ₦${Payment.cr ? Payment.crAmount : Payment.drAmount} 
                                    </span>
                                </small>
                                   
                                  <div>   
                                        <a class="link-offset-2 link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover" href="/api/v1/payments/${Payment._id }">${Payment.cr ?'CR' :'DR'}/${Payment.collectionRef}/${Payment.paymentReferenceNo}/${Payment.PaymentDate}</a>  
                                  </div>
                                  <div>
                                  </div>
                                 <small class="${Payment.status === 'posted' ? "bg-success" : "bg-secondary"}
                                 text-light p-1 rounded shadow"> ${Payment.status}</small>
                                </div> 
                            </span>
      `
      });
       document.getElementById('tbody').innerHTML = product
    
  })


              //get customer details
            let customerinfo
            let PaymentAccount
              const customer = document.getElementById('customer').addEventListener('change',async function(e){
                  const endpoint = `/api/v1/customer/${e.target.value}/search`
                  const request = await fetch(endpoint,{
                      method: 'GET',
                      headers:{'content-type': 'application/json'},
                  })
                  // reset PaymentAccount
                  PaymentAccount = ''
                  document.getElementById('PaymentAccount').innerText =  `${PaymentAccount ? PaymentAccount : 'No Account Assigned'}`
                  const responses = await request.json()
                  // show customer debt
                  document.getElementById('debt').innerHTML = `₦${responses.item.Debt}`
                  customerinfo = responses.item
      
                  // show customer debt
                  document.getElementById('customerName').innerHTML = `${responses.item.Username}`
                  
                   // show customer wallet
                   document.getElementById('dwp').innerHTML = `₦${responses.item.creditLimit}`
                  // customerinfo = responses.item
      
                 try {
                  PaymentAccount = responses.Accounts.bankCode
                  document.getElementById('PaymentAccount').innerText =  `${PaymentAccount ? PaymentAccount : 'No Bank Journal Assigned'}`
                 } 
                 catch (error) {
                    if (!error ){
                      document.getElementById('submit').setAttribute('disabled',false)
                    }else{
                      document.getElementById('submit').setAttribute('disabled',true)
                    }
                 }
                 
              })
      
              
              //submit for payment
              
              let Amount = document.getElementById('Amount').addEventListener('change',(e)=>{
                Amount.value = parseInt(e.target.value < 0 ? e.target.value = 1 : e.target.value )
              })
      
              const paymentForm = document.getElementById('paymentForm')
              paymentForm.addEventListener('submit',async(e) => {
                  e.preventDefault()
                  document.getElementById('submit').setAttribute('disabled',true)
                    const PaymentRequest = await fetch('/api/v1/CREDIT/log',{
                      method:"POST",
                      body: JSON.stringify({
                          Accountant:paymentForm.Accountant.value,
                          Amount : paymentForm.Amount.value,
                          PaymentDate:paymentForm.PaymentDate.value,
                          bankAccount:PaymentAccount,
                          // remarks:paymentForm.remarks.value,
                          customer:paymentForm.customer.value,
                          previousBalance:parseInt(customerinfo.Debt),
                          TRANSACTION:paymentForm.TRANSACTION.value,
                          paymentReferenceNo:paymentForm.PaymentRef.value,
                      }),
                      headers:{'Content-Type': 'application/json'}
                     })
      
                     const PaymentResponse = await PaymentRequest.json()
                     ShowServerResponse(PaymentResponse.message || PaymentResponse.error)
                     if(PaymentResponse.message){
                      location.reload()
                     }
                    if (PaymentResponse.error){
                      document.getElementById('submit').setAttribute('disabled',false)
                    }
              });
              
          </script>
      
    </body>
</html>
