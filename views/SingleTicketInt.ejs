<!doctype html>
<html lang="en">

<head>
  <title><%= name %> || <%= SingleLead.TicketId%></title>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="icon" type="image/x-icon" href="https://allchannels.com.ng/BADES.jpg">
  <%-include('./partials/inactive.ejs')%>
  <%-include('./partials/Notification.ejs')%>
  <!-- Bootstrap CSS v5.2.1 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/chat.css">
  <link rel="stylesheet" href="/sale.css" />
</head>
<body>
  <header>
    <!-- place navbar here -->
    <nav class="dash navbar navbar-expand navbar-light shadow bg-light fixed-top">
      <ul class="nav navbar-nav">
        <li class="nav-item">
          <a class="nav-link " onclick="history.back()" aria-current="page">
            <img title="Back" style="width: 40px !important;height: 40px !important;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEgklEQVR4nO2a/U/VVRzH31xEbjxEQmjYAobWUkdYIiYxYYg8c+/9HrqUhAaFbvaE60lnOVzTrRbFMCZjNkmvGV6433NjjY2W1WzrgVHNkq0VtkxXZmqaUwyBTzv0Zd01TO4ZP3zP5b628we8vp/z9P5+DhAkSJAgUw1RyPpWCsN0wOmmUI1TK+Pkzf6IZiCQcbpppqZTO+NEYmicXPX1ZEEgUtpFEYxT97isz2hGoOF0UxTjdGgC2fFKb0Og4HRTLOP0xbVkfcYzUB3NQwmM07eTkCWm0yjj9ChUhXVSisbp2KRk/53aw5pOTqiGndNiptMpf2R9pLdDJRw6ZTBOZ2Rkcxu+PAhAnQuJ5qFcjdNFv2V1Gl2+me8FsBpAJlTAoZNd4zTo9xTWR0bS6/a1GLI2ANEwO4zTGqbTVb9lPcNDd9U2vW7IlgCIgNnROD1pHCl+yTo6hwYXVr60w5AtABAOs6Nx2iSzOdk7rlycX/b0VkN2pfk3KqIQplOjjKyt/dIfibk1zxuyKwCEwuzxjum0R0a27O0LpxMy7Bt9dmNzJ6XCbgpnnDwysqWucyfjFq14zJBNBxACM1PVQ5GM0/sysiV7Tw/EJKetM2TTYHZK3qNZjNNnMrJFu0/0R8xJqTFkF8DsON10i6bTERnZgpZjfdbo+LUAHgQwD2bHzilZ0+kHGdm8nf2fWKyRVQAeAJAIs+P00kJNp5MysrkNfT0WS1glgAoACTA75V5KZzr9LiObveNwl7FeywHEw+yUc8phOv0plXi2dLkMWQ3ALJgdxqlMNvEsrXO1GrJ2JRLPFAmrkXh8CE2rbdro6PhrUGZK29svizuyUtwtpuW84sdfcBwc9H8d/yP+MhQiFECOkE7MrnrW9s6ls1LSnJpVaqFYANwnpOcsKX6qdP952b+PLpWaZSEAlgrpuDsyN5TsO3Nccnq/+3AbWaEQi4V0VOKi2uK2X6WumJpOH9q8pMYxZbBQSEfE31ZduPv4N5JrutehUxwUYr5IPGHRsWvzd33fK1npfpuX5kIhkkTysYRZH1rZeORjSekfHTqZPyb6ICpUAYulMueVzydqbk9m/GLnlAqFmA3gfrGuM7d2H5A8ss5qHroXChErrt5Cetkmz1syP+LHelBeyoNC3Ggko9VLntizS9NHhiXO6Sual0SUVIZI8V5FSKc+0tjg8Fwdkqi0+FDVUAgrgCIhfWdF/XbRM5Ko9CjTqQ4KMRPAKiGdUlr3ot096H+PWMGkNWM8aSXlr99sb798fjo8ebAAyBLSCem2urIDF36bDo9aQgBkjCWtBVkbSl3nfp7sOl72XMcbyvwPm4B7hHRMYuq6krZTA9cTXr6la79Sbzz+P2kl1RS9eeLotWSztn3Qacjmm785fn1uF0krPHZudWHrT1//Vzbn1d4eQ7ZYiWcPkyR5LF5G3LRmVfN3n47L5jUdPWy0ZMoA3IAA41aRtES8zH3tq0MFLQN9RrPNASAKAcrssaRlsVSGWaOrjP6T+VsyU5S0RGfxZkwTYoxqBwkC//gbNIgEXXRi6msAAAAASUVORK5CYII=">
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="#"><b><%= SingleLead.TicketId%>/<%=SingleLead.name.toUpperCase() %></b></a>
        </li>
      </ul>
    </nav>
  </header>
  <main class="overflow-hidden pt-4">
    <div class="container bg-body-tertiary border shadow p-2 mt-5 mb-3  ">
      <!-- place main content here -->
      <form class="row g-3 mb-3 " id="TicketForm">
        <h6><%=SingleLead.name.toUpperCase() %>'s Support Ticket.</h6>
        <div class="col-md-4">
          <label for="validationDefault01" class="form-label">Full Name</label>
          <input type="text" class="form-control" value="<%=SingleLead.name.toUpperCase() %>" id="validationDefault01"required>
        </div>
        <div class="col-md-4">
          <label for="validationDefault02" class="form-label">Contact Date</label>
          <input type="date" class="form-control" id="validationDefault02" readonly value="<%=SingleLead.date.toUpperCase() %>" required>
        </div>
        <div class="col-md-4">
          <label for="validationDefaultUsername" class="form-label">Email</label>
          <div class="input-group">
            <span class="input-group-text" id="inputGroupPrepend2">@</span>
            <input type="text" class="form-control" id="validationDefaultUsername" value="<%=SingleLead.email %>" aria-describedby="inputGroupPrepend2" required>
          </div>
        </div>
        <div class="col-md-6">
          <label for="validationDefault03" class="form-label">Issue</label>
          <input type="text" class="form-control" readonly id="validationDefault03" disabled value="<%= SingleLead.Issue %>" required>
        </div>
        <div class="col-md-4">
          <label for="validationDefault03" class="form-label">Priority</label>
          <input type="text" class="form-control" readonly id="validationDefault03" disabled value="<%= SingleLead.Priority %>" required>
        </div>
        <div class="col-md-4">
          <label for="validationDefault03" class="form-label">status</label>
          <input type="text" class="form-control" readonly id="validationDefault03" disabled value="<%= SingleLead.status %>" required>
        </div>
        <div class="col-md-3">
          <label for="internalUnitId" class="form-label">Assign to Internal Unit</label>
          <select class="form-select" id="internalUnitId"  name="internalUnitId" >
            <option value="">Choose...</option>
            <%if(SingleLead.internalUnitId){%>
              
              <%if(admin.length > 0 && SingleLead.internalUnitId){%>
                <%Department = admin.filter(contract=>{%>
                  <%return contract._id.toString() === SingleLead.internalUnitId.toString() %>
                  <%})%>
                  <%Department.map(dpt=>{%>
                    <option value="<%=SingleLead.internalUnitId%>" class="bg-warning"><%=dpt.Name%> [current]</option> 
                <%})%>
                  <%}else{%>
                    Not Assigned
                 <% }%>

            <%}%>

            <% admin.forEach(element => { %>
            <option value="<%= element._id %>"><%= element.Name %></option>
            <% }) %>

          </select>
        </div>
        <div class="col-md-3">
          <label for="validationDefault05" id="Telephone" class="form-label">Telephone</label>
          <input type="text" class="form-control" id="Telephone" name="Telephone" value="<%=SingleLead.tel%>" required>
        </div>
        <div class="col-12">
          <div class="form-check form-switch">
            <input class="form-check-input" name="closeTicket" type="checkbox" id="closeTicket" <%if(SingleLead.status === 'Closed' ){%>
              checked="checked"
              <%}%>>
            <label class="form-check-label" for="closeTicket">Close Support <%= SingleLead.TicketId%></label>
          </div>
        </div>
        <% if (SingleLead.status !== 'Closed') { %>
        <div class="col-12">
          <button class="btn btn-success " type="submit">Update Changes</button>
        </div>
        <% } %>
        <input type="hidden" name="ticketId" readonly hidden value="<%= SingleLead._id%>">
      </form>
      <script>
        const TicketForm = document.getElementById('TicketForm')
        TicketForm.addEventListener('submit', async (event) => {
          event.preventDefault()
          plsWait(true)
          const request = await fetch(`/api/v1/TicketId?TicketId=${TicketForm.ticketId.value}`,{
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              internalUnitId:TicketForm.internalUnitId.value,
              status:TicketForm.closeTicket.checked ? 'Closed' : 'Open',
            })
          })
          const response = await request.json()
          if(response.error){
            serverError(response.error)
            plsWait(false)
            return
          }else{
            ShowServerResponse(response.message)
            location.reload()
          }
        })
      </script>
      <hr>
      <h5>Chat with <%= SingleLead.name  %></h5>
      <!-- chat display  -->
      <div class="container  d-flex flex-column overflow-y-auto overflow-x-hidden rounded p-3 mb-5  " style="height:400px" id="display">
        <% if (SingleLead.conversation.length > 0 ) { %>
        <% SingleLead.conversation.forEach(element => { %>

            <div class="chatContainer shadow-sm time-left
            <% if (element.senderId.toString() === '' ) { %>
                bg-warning-subtle right
            <% }%>
                    ">
        <!-- <img src="/person.png" alt="Avatar" <% if (element.senderId.toString() !== SingleLead._id.toString() ) { %> class="right" <% }%> style="width:60%;" /> -->
        <p class="word-wrap"><%= element.messageBody %></p>
        <span class="time-left ">
        <% if (element.senderId.toString() === '') { %>
        <%=  element.author %> <%= element.Timestamp %>
        <% }else{%>
        Support <%= element.Timestamp %>
        <%}%>
        </span>
        </div>
                    <% }) %>
            <% } else{%>
            <p>Say hello to <%= SingleLead.name %></p>
            <%}%>
                   </div>
                  <!-- chat input -->
                </div>
              <% if (SingleLead.status !== 'Closed') { %>
            
                <form id="chatForm" class="p-3 shadow fixed-bottom bg-body-tertiary ">
                  <div class="input-group" id="chatId" data-chatId="<%= SingleLead._id %>">
                    <input type="hidden" name="author" value="<%=SingleLead.name%>">
                    <input type="text" class="form-control" placeholder="Type a Message to <%= SingleLead.name %>" name="message" id="sender" required autocomplete="off" <% if (SingleLead.status !== 'Open') { %>
                        disabled
                       <% } %> data-senderId="<%=user._id%>">
                    <button class="btn btn-warning " title="Send message"><i class="bi bi-send-fill"></i></button>
                    <a href="tel:<%=SingleLead.tel%>" title="Call <%=SingleLead.name%>" class="btn btn-outline-dark "><i class="bi bi-telephone-forward"></i> </button>
                        <a href="mailto:<%= SingleLead.email %>" title="Email <%=SingleLead.name%>" class="btn btn-link btn-outline-info "><i class="bi bi-envelope-at-fill"></i></button>
                        <a class="btn btn-dark" title="Share Invite"> <i class="bi bi-share-fill"></i></a>
                </div>
              </form>
            <% } %>
  </main>
  <footer>
    <!-- place footer here -->
  </footer>
  <!-- Bootstrap JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js" integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/js/chatForm.js"></script>
</body>

</html>